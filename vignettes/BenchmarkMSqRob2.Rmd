---
title: "Benchmarking the msqrob2 package using the Ionstar Dataset starting from peptides.txt"
author: "FGCZ - (Draft)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      toc_collapsed: true
papersize: a4
geometry: margin=.5in
vignette: >
  %\VignetteIndexEntry{Benchmarking the proDA package using the Ionstar Dataset starting from peptides} 
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r setup, include=TRUE} 
library(tidyverse)
library(limma)
library(QFeatures)
library(msqrob2)
library(plotly)
library(gridExtra)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
evalAll <- require(proDA)
SAVE = TRUE

```


# msqrob2 benchmark based on peptide.txt intensities and median polish


```{r fromPeptideTXT , eval = evalAll}
datadir <- file.path(find.package("prolfquadata") , "quantdata")
inputMQfile <-  file.path(datadir,
                          "MAXQuant_IonStar2018_PXD003881.zip")
inputAnnotation <- file.path(datadir, "annotation_Ionstar2018_PXD003881.xlsx")
mqdata <- list()
mqdata$data <- prolfqua::tidyMQ_Peptides(inputMQfile)
length(unique(mqdata$data$proteins))
mqdata$config <- prolfqua::create_config_MQ_peptide()

annotation <- readxl::read_xlsx(inputAnnotation)
res <- prolfqua::add_annotation(
  mqdata$data,
  annotation,
  fileName = "raw.file"
)

mqdata$config$table$factors[["dilution."]] = "sample"
mqdata$config$table$factors[["run_Id"]] = "run_ID"
mqdata$config$table$factorDepth <- 1
mqdata$data <- prolfqua::setup_analysis(res, mqdata$config)


lfqdata <- prolfqua::LFQData$new(mqdata$data, mqdata$config)
lfqdata$data <- lfqdata$data |> dplyr::filter(!grepl("^REV__|^CON__", protein_Id)) 
lfqdata$filter_proteins_by_peptide_count()
lfqdata$hierarchy_counts()

lfqdata$remove_small_intensities()
lfqdata$hierarchy_counts()

tr <- lfqdata$get_Transformer()
subset_h <- lfqdata$get_copy()
subset_h$data <- subset_h$data |> dplyr::filter(grepl("HUMAN", protein_Id))
subset_h <- subset_h$get_Transformer()$log2()$lfq
lfqdataNormalized <- tr$log2()$robscale_subset(lfqsubset = subset_h)$lfq

```

```{r}

se <- prolfqua::LFQDataToSummarizedExperiment(lfqdata = lfqdataNormalized)

tolong <- function(assay, rowData, colData ){
  annot <- as_tibble(data.frame(colData))
  hierarchy <- prolfqua::matrix_to_tibble( data.frame( rowData ) )
  ll <- prolfqua::matrix_to_tibble(assay)
  ll <- ll |> pivot_longer(cols = -all_of("row.names"), names_to = "sampleName", values_to = "intensity")
  hl <- inner_join(hierarchy, ll)
  ahl <- inner_join(annot, hl)
}



pe <- QFeatures::QFeatures(list(peptide = se), colData = colData(se))
pe <- QFeatures::aggregateFeatures(pe,
                                   i = "peptide", fcol = "protein_Id",
                                   name = "protein"
)

ld <- tolong( assay(pe[["protein"]]), rowData(pe[["protein"]]), colData(pe))
protabund <- ld |> dplyr::group_by( protein_Id ) |> dplyr::summarize(avg_abundance = mean(intensity, na.rm=TRUE))

```

To use `proDA`, we need to create an `SummarizedExperiment`. We use the `to_wide` function of `prolfqua` to get the data in in the `SummarizedExperiment` compatible format.


## Defining Contrasts and computing group comparisons

As usual, two steps are required, first fit the models, then comptue the contrasts.


```{r runProda, eval=evalAll, include=TRUE}
prlm <- msqrob2::msqrob(
  object = pe, 
  i = "protein",
  formula = ~dilution.,
  overwrite = TRUE)

getModel(rowData(prlm[["protein"]])$msqrobModels[[2]])

prlm <- msqrobHurdle(prlm,
                     i = "protein",
                     formula = ~dilution.,
                     overwrite = TRUE)

L <- makeContrast(c("dilution.e-dilution.d=0"),
                  parameterNames = c("dilution.e", "dilution.d"))
prlm <- hypothesisTest(object = prlm, i = "protein", contrast = L,  overwrite = TRUE,  resultsColumnNamePrefix = "rlm_")
prlm <- hypothesisTestHurdle(prlm, i = "protein", L, overwrite=TRUE)

L <- makeContrast(c("dilution.d-dilution.c=0"),
                  parameterNames = c("dilution.d", "dilution.c"))
prlm <- hypothesisTest(object = prlm, i = "protein", contrast = L, overwrite = TRUE,  resultsColumnNamePrefix = "rlm_")
prlm <- hypothesisTestHurdle(prlm, i = "protein", L, overwrite=TRUE)


L <- makeContrast(c("dilution.c-dilution.b=0"),
                  parameterNames = c("dilution.c", "dilution.b"))
prlm <- hypothesisTest(object = prlm, i = "protein", contrast = L,  overwrite = TRUE, resultsColumnNamePrefix = "rlm_")
prlm <- hypothesisTestHurdle(prlm, i = "protein", L, overwrite = TRUE)

L <- makeContrast(c("dilution.b=0"),
                  parameterNames = c("dilution.b"))
prlm <- hypothesisTest(object = prlm, i = "protein", contrast = L,  overwrite = TRUE, resultsColumnNamePrefix = "rlm_")
prlm <- hypothesisTestHurdle(prlm, i = "protein", L, overwrite = TRUE)

xx <- rowData(prlm[["protein"]])

hurdle <- xx[grepl("hurdle_",names(xx))]

res <- list()
for (i in names(hurdle)) { 
  print(i)
  hurdle[[i]]$contrast <- i
  res[[i]] <- prolfqua::matrix_to_tibble(hurdle[[i]], preserve_row_names = "name")
}

hurdle <- dplyr::bind_rows(res)
nrow(hurdle)/4
hurdle$contrast |> unique()
hurdle |> filter(contrast == "hurdle_dilution.b")

hurdle$name |> unique() |> length()


rlm_cont <- xx[grepl("rlm_", names(xx))]
res <- list()
for (i in names(rlm_cont)) { 
  print(i)
  rlm_cont[[i]]$contrast <- i
  res[[i]] <- prolfqua::matrix_to_tibble(rlm_cont[[i]], preserve_row_names = "name")
}
rlm_cont <- dplyr::bind_rows(res)
nrow(rlm_cont)/4
rlm_cont$name |> unique() |> length()



```




```{r}

logFC <- hurdle |> select("name","contrast", starts_with("logFC"))
logFC <- filter(logFC ,!is.na(logFCt))
logOR <- hurdle |> select("name","contrast", starts_with("logOR"))
ddd <- anti_join(logOR , logFC)
names(ddd) <- names(logFC)
all <- bind_rows(ddd , logFC) |> arrange(contrast, name)
names(all) <- c("name","contrast","logFC","se","df","t","pval")
all <- prolfqua::adjust_p_values(all, column = "pval", group_by_col = "contrast")

```


## Benchmarking


```{r setUPBenchmark, eval = evalAll}
bb <- inner_join(all, protabund, by=c("name" = "protein_Id"))
ttd <- prolfqua::ionstar_bench_preprocess( bb , idcol = "name" )

benchmark_msqrob <- prolfqua::make_benchmark(ttd$data,
                                             contrast = "contrast",
                                             toscale = c("pval"),
                                             fcestimate = "logFC",
                                             benchmark = list(
                                               list(score = "logFC", desc = TRUE),
                                               list(score = "t", desc = TRUE),
                                               list(score = "scaled.pval", desc = TRUE)
                                             ),  
                                             model_description = "msqrob_QFeature",
                                             model_name = "msqrob_QFeature",
                                             FDRvsFDP = list(list(score = "pval.adjusted", desc = FALSE))
                                             , hierarchy = c("name"), summarizeNA = "t"
)


sum(benchmark_msqrob$smc$summary$name)
sumarry <- benchmark_msqrob$smc$summary
prolfqua::table_facade(sumarry, caption = "nr of proteins with 0, 1, 2, 3 missing contrasts.")



```


```{r prepBenchmarkforComparison, include= FALSE, eval = evalAll}
xdd <- ttd$data |> dplyr::rename(protein_Id = name ,
                                 contrast = contrast,
                                 avgInt = avg_abundance,
                                 diff = logFC,
                                 statistic = t,
                                 p.value = pval,
                                 FDR = pval.adjusted  
)

benchmark2_msqrob <- prolfqua::make_benchmark(xdd, model_description = "msqrob", model_name = "msqrob")

```

```{r eval=SAVE, include=FALSE}
saveRDS(benchmark2_msqrob, file = "../inst/Benchresults/benchmark_msqrob.RDS")

```

```{r rocCurve, fig.cap="ROC curves", eval = evalAll}
res <- benchmark_msqrob$pAUC_summaries()
knitr::kable(res$ftable$content,caption = res$ftable$caption)
res$barp
```

```{r pAUC02, fig.cap="plot ROC curves", eval = evalAll}
#res$ftable
benchmark_msqrob$plot_ROC(xlim = 0.1)
```

```{r fdrfdp, fig.cap = "plot FDR vs FDP",eval = evalAll}
benchmark_msqrob$plot_FDRvsFDP()
```

```{r fdptpr,eval = evalAll}
benchmark_msqrob$plot_FDPvsTPR()
```
